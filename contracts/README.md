# PrivateZK Credit Scout - Smart Contracts

Zero-knowledge credit scoring smart contracts for Mantle Network, using EZKL Groth16 proofs for private, verifiable credit scores.

## Overview

This Hardhat project implements on-chain credit scoring with zero-knowledge proofs:

- **Verifier.sol**: EZKL Groth16 verifier contract (generated by EZKL pipeline)
- **PrivateCreditLending.sol**: Main contract for submitting and storing verified credit scores
- **MockVerifier.sol**: Mock verifier for testing (test-only, never deploy to production)

## Features

- ðŸ”’ **Zero-Knowledge Verification**: Credit scores verified on-chain without revealing private inputs
- ðŸ“Š **Explainable Scores**: Top 3 feature contributions (SHAP impacts) stored with each score
- âœ… **Production Ready**: Comprehensive test suite with >95% coverage
- ðŸš€ **Mantle Optimized**: Deployed on Mantle testnet (Sepolia)

## Project Structure

```
contracts/
â”œâ”€â”€ contracts/
â”‚   â”œâ”€â”€ Verifier.sol              # EZKL Groth16 verifier (generated)
â”‚   â”œâ”€â”€ PrivateCreditLending.sol  # Main lending contract
â”‚   â””â”€â”€ MockVerifier.sol          # Test-only mock verifier
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ deploy_all.ts             # Deploy both contracts
â”‚   â””â”€â”€ export_abis.ts            # Export ABIs for frontend
â”œâ”€â”€ test/
â”‚   â”œâ”€â”€ PrivateCreditLending.test.ts  # Main contract tests
â”‚   â””â”€â”€ MockVerifier.test.ts          # Mock verifier tests
â”œâ”€â”€ hardhat.config.ts             # Hardhat configuration
â””â”€â”€ package.json
```

## Prerequisites

- Node.js >= 18.0.0
- npm >= 9.0.0
- Hardhat >= 2.22.0
- Mantle testnet account with testnet ETH (for deployment)

## Installation

```bash
cd contracts
npm install
```

## Configuration

1. Copy `.env.example` to `.env`:
```bash
cp .env.example .env
```

2. Add your private key to `.env`:
```
PRIVATE_KEY=your_private_key_here
```

**âš ï¸ WARNING**: Never commit your `.env` file or private keys to version control!

## Compile Contracts

```bash
npm run compile
```

## Testing

### Run all tests:
```bash
npm test
```

### Run with verbose output:
```bash
npm run test:verbose
```

### Generate coverage report:
```bash
npm run coverage
```

Coverage report will be generated in `coverage/` directory. Open `coverage/index.html` in your browser to view detailed coverage.

### Test Coverage

The test suite includes:
- âœ… Valid proof verification and storage
- âœ… Invalid proof rejection
- âœ… Multi-user scenarios
- âœ… Score updates
- âœ… Boundary conditions (min/max scores, zero, large values)
- âœ… Positive/negative/mixed contributions
- âœ… Event emissions
- âœ… Gas optimization checks

**Current coverage: >95%**

## Deployment

### 1. Get Testnet ETH

Get testnet ETH from the Mantle faucet:
- **Faucet**: https://faucet.sepolia.mantle.xyz
- Request testnet ETH for your deployment address

### 2. Deploy to Mantle Testnet

```bash
npm run deploy
```

The script will:
- Deploy Verifier contract
- Deploy PrivateCreditLending contract
- Log contract addresses
- Generate explorer links
- Output frontend `.env` configuration
- Save deployment info to `deployments/`

### 3. Deploy to Local Network

For local testing:
```bash
npx hardhat node  # Terminal 1: Start local node
npm run deploy:local  # Terminal 2: Deploy contracts
```

### Deployment Output

After deployment, you'll see:
```
============================================================
Deployment Summary
============================================================
Network: mantle_testnet (Chain ID: 5003)
Explorer: https://explorer.sepolia.mantle.xyz

Contract Addresses:
  Verifier:            0x...
  PrivateCreditLending: 0x...

Explorer Links:
  Verifier:            https://explorer.sepolia.mantle.xyz/address/0x...
  PrivateCreditLending: https://explorer.sepolia.mantle.xyz/address/0x...
```

### Frontend Integration

The deployment script outputs environment variables for your frontend:

```bash
# Add to your frontend .env file
VITE_VERIFIER_ADDRESS=0x...
VITE_PRIVATE_CREDIT_LENDING_ADDRESS=0x...
VITE_NETWORK_CHAIN_ID=5003
VITE_EXPLORER_URL=https://explorer.sepolia.mantle.xyz
```

These are also saved to `.env.deployment` in the contracts directory.

## Export ABIs

Export contract ABIs for frontend integration:

```bash
npm run export:abis
```

This will:
1. Compile contracts
2. Export ABIs to `abis/` directory:
   - `Verifier.json`
   - `PrivateCreditLending.json`
   - `all.json` (combined)

## Frontend Integration

Integrate contracts with the frontend (copies ABIs and updates config):

```bash
npm run integrate:frontend
```

This automatically:
- Exports contract ABIs
- Copies ABIs to `client/src/lib/contracts/`
- Creates/updates frontend `.env.example`

**For complete integration guide, see [INTEGRATION.md](./INTEGRATION.md)**

## Contract Details

### PrivateCreditLending

**Functions:**
- `submitScore(bytes calldata proof, uint256 publicScore, int256[3] calldata contributions)`: Submit a verified credit score
- `getCreditScore(address user)`: Get credit score for a user

**Events:**
- `ScoreSubmitted(address indexed user, uint256 score, int256[3] contributions)`: Emitted when a score is submitted

**Storage:**
- `mapping(address => uint256) public creditScores`: Maps user addresses to their verified scores

### Verifier

The `Verifier.sol` contract is generated by the EZKL pipeline. To generate it:

```bash
# From the zkml directory
python3 ezkl_pipeline.py
```

This will generate `contracts/Verifier.sol` with the actual Groth16 verifier implementation.

**âš ï¸ Important**: The placeholder `Verifier.sol` will revert on deployment. You must generate the real verifier using EZKL before deploying.

## Usage Example

### TypeScript/ethers.js

```typescript
import { ethers } from "ethers";
import PrivateCreditLendingABI from "./abis/PrivateCreditLending.json";

const provider = new ethers.JsonRpcProvider("https://rpc.sepolia.mantle.xyz");
const signer = await provider.getSigner();

const lendingAddress = "0x..."; // From deployment
const lending = new ethers.Contract(
  lendingAddress,
  PrivateCreditLendingABI,
  signer
);

// Submit score with proof
const proof = "0x..."; // From EZKL proof generation
const score = 720;
const contributions = [-234, 189, -123]; // Top 3 feature impacts

const tx = await lending.submitScore(proof, score, contributions);
await tx.wait();

// Get score
const userScore = await lending.getCreditScore(signer.address);
console.log(`Credit score: ${userScore}`);
```

## CI/CD

GitHub Actions workflow runs on every push/PR:
- Compiles contracts
- Runs test suite
- Generates coverage reports
- Uploads coverage artifacts

See `.github/workflows/ci.yml` for details.

## Hackathon Tips

### Demo Video Recommendations

1. **Show the Flow**:
   - Input features â†’ Generate proof â†’ Submit to contract
   - Verify transaction on explorer
   - Show score stored on-chain

2. **Highlight Privacy**:
   - Explain that inputs are private (not revealed)
   - Show only public outputs (score + contributions)
   - Demonstrate ZK proof verification

3. **Mantle Integration**:
   - Show fast, low-cost transactions
   - Display explorer links
   - Highlight testnet deployment

### Testnet Links

- **Explorer**: https://explorer.sepolia.mantle.xyz
- **Faucet**: https://faucet.sepolia.mantle.xyz
- **RPC**: https://rpc.sepolia.mantle.xyz
- **Chain ID**: 5003

### Deployment Checklist

- [ ] Get testnet ETH from faucet
- [ ] Generate EZKL verifier (if not already done)
- [ ] Deploy contracts: `npm run deploy`
- [ ] Verify contracts on explorer (optional)
- [ ] Update frontend `.env` with contract addresses
- [ ] Export ABIs: `npm run export:abis`
- [ ] Test end-to-end flow

## Troubleshooting

### "Invalid verifier address" error
- Ensure the verifier contract is deployed first
- Check that the address is correct (not zero address)

### "Invalid proof" error
- Verify proof was generated correctly with EZKL
- Ensure public inputs match (score + contributions)
- Check that proof format matches verifier expectations

### Deployment fails with "insufficient funds"
- Get testnet ETH from faucet: https://faucet.sepolia.mantle.xyz
- Check account balance: `npx hardhat run scripts/check_balance.ts --network mantle_testnet`

### Compilation errors
- Run `npm run clean` and recompile
- Ensure Solidity version matches (0.8.24)
- Check for syntax errors in contracts

## Security Considerations

- âš ï¸ **Never deploy MockVerifier to production** - it's test-only
- âš ï¸ **Protect your private keys** - never commit `.env` files
- âš ï¸ **Verify contracts on explorer** before using in production
- âš ï¸ **Audit contracts** before mainnet deployment
- âš ï¸ **Generate real EZKL verifier** - placeholder will revert

## License

MIT

## Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests for new functionality
5. Ensure tests pass and coverage >95%
6. Submit a pull request

## Support

For issues or questions:
- Open an issue on GitHub
- Check the main project README: `../README.md`
- Review EZKL documentation: https://github.com/zkonduit/ezkl

